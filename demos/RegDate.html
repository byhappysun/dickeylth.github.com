---
layout: page
title: 日期按格式校验
group: demo
---
<!DOCTYPE html>
<html>
<head>
    <title>Test Date</title>
    <meta charset="UTF-8">
    <script src="http://a.tbcdn.cn/??s/kissy/1.3.0/kissy-min.js,p/global/1.0/global-min.js?t=2012082320100214.js"></script>
</head>
<body>
    <form id="formatData">
        <ul>
            <li>
                <label for="dateStr">请输入日期串： <input type="text" name="dateStr" id="dateStr" placeholder="日期串"/></label>
            </li>
            <li>
                <label for="pattern">请输入格式： <input type="text" name="pattern" id="pattern" placeholder="例如：YYYY-MM-DD hh:mm:ss"/></label>
            </li>
            <li>
                <input type="button" class="btn btn-primary" id="submit" value="提交"/>
            </li>
        </ul>
        <p id="result"></p>
    </form>
    <script>
        KISSY.use('core', function(S){

            S.one('#submit').on('click', function(){
                var dateStr = S.one('#dateStr').val();
                var pattern = S.one('#pattern').val();

                var text = {
                    true: '恭喜您，日期校验匹配！',
                    false: '对不起，校验失败，请重试！'
                }

                S.one('#result').text(text[formatDate(dateStr, pattern)]);
            });

            function formatDate(str, pattern){
                str = S.trim(str);
                pattern = S.trim(pattern);

                var result = true;

                var MONTH_30_DAYS = [4, 6, 9, 11];
                var SIGNS = {
                    'Y': 'year',
                    'M': 'month',
                    'D': 'date',
                    'h': 'hour',
                    'm': 'minute',
                    's': 'second'
                };
                var SIGNS_KEYS = S.keys(SIGNS);

                var formatObj = {
                    year: 0,
                    month: 0,
                    date: 0,
                    hour: 0,
                    minute: 0,
                    second: 0
                };

                var isLeapYear = function(year){
                    if((year % 4 == 0 && year % 100 != 0) || (year % 400 == 0)){
                        return true;
                    }
                    return false;
                };

                var isValidDate = function(obj){

                    var valid = true;
                    obj.isLeapYear = isLeapYear(obj.year);

                    var maxDate = 31;
                    if(S.inArray(obj.month, MONTH_30_DAYS)){
                        maxDate = 30;
                    }else if(obj.month == 2){
                        maxDate = obj.isLeapYear ? 29 : 28;
                    }

                    var rangeMap = {
                        year: [1, 9999],
                        month: [1, 12],
                        date: [1, maxDate],
                        hour: [0, 60],
                        minute: [0, 60],
                        second: [0, 60]
                    };
                    S.each(rangeMap, function(range, key){
                        if(range[0] > obj[key] || range[1] < obj[key]){
                            valid = false;
                            return false;
                        }
                    });
                    return valid;
                };

                if(str && pattern){
                    for(var i = 0; i < pattern.length; i++){
                        var pa = pattern[i];
                        if(S.inArray(pa, SIGNS_KEYS)){
                            if(pa == 'Y'){
                                var year = parseInt(str.substr(i, 4));
                                if(!year){
                                    result = false;
                                    return false;
                                }
                                formatObj.year = year;
                                i += 3;
                            }else{
                                var val = parseInt(str.substr(i, 2));
                                if(!val){
                                    result = false;
                                    return false;
                                }
                                formatObj[SIGNS[pa]] = val;
                                i++;
                            }
                        }else if(pa != str[i]){
                            result = false;
                            return false;
                        }
                    }
                    if(str[i]){
                        result = false;
                    }else if(result){
                        return isValidDate(formatObj);
                    }

                }
                return result;
            }
        });

    </script>
</body>
</html>